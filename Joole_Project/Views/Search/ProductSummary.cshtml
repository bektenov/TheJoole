@{
    ViewBag.Title = "Index";
    @model IEnumerable<TheJooleProject.Models.ProductDetailsVM>
    List<TheJooleProject.Models.ProductDetailsVM> array = ViewBag.Model;
    int count = array.Count + 1;
    @model JooleProject.Models.SearchVM
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>@ViewBag.Title - TropicalServer</title>
    <link href="~/Content/productsummary.css" rel="stylesheet" />
    <script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>


    </script>
    @Styles.Render("~/Content/productsummary")
    @Scripts.Render("~/Scripts/Product.js")
</head>
<body>

    <div class="d-inline-block">
        <nav class="navbar fixed-top navbar-dark" id="header">
            <a class="narbar-brand my-2" href="#">
                <img src="~/Content/image/jooleImg.png" width="100" height="40" alt="" />
            </a>


            @using (Html.BeginForm("AdvanceSearch", "Search"))
            {

                <div class="row">
                    <div class="col" style="display:inline-block">
                        @Html.DropDownListFor(Model => Model.Category_Id, (IEnumerable<SelectListItem>)ViewBag.Category_Name, "Category", htmlAttributes: new { @class = "form-select" })
                    </div>
                    <div class="col" id="sss" style="display:inline-block">
                        @Html.TextBoxFor(Model => Model.Product_Name, new { @class = "form-select", id = "sss" })
                    </div>
                    <div class="col" style="display:inline-block">
                        <button type="submit" class="btn btn-primary">
                            @* <i class="fas fa-search">&nbsp; </i>*@
                            <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-search" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                <path fill-rule="evenodd" d="M10.442 10.442a1 1 0 0 1 1.415 0l3.85 3.85a1 1 0 0 1-1.414 1.415l-3.85-3.85a1 1 0 0 1 0-1.415z" />
                                <path fill-rule="evenodd" d="M6.5 12a5.5 5.5 0 1 0 0-11 5.5 5.5 0 0 0 0 11zM13 6.5a6.5 6.5 0 1 1-13 0 6.5 6.5 0 0 1 13 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
            }
        </nav>
    </div>


    <div id="product-summary-page">
        <div id="options">
            <div id="options-search-bar">
                <label id="options-search-label">Search:</label>
                <button class="options-search-buttons" id="options-search-save">Save</button>
                <button class="options-search-buttons" id="options-search-clear">Clear</button>
            </div>
            <div id="options-buttons-div">
                <div class="options-buttons" id="options-buttons-product">Product</div>
                <div class="options-buttons" id="options-buttons-project">Project</div>
            </div>
            <div id="product-box">
                <div class="collapsible" id="product-type-button">
                    Product Type
                </div>
                <div id="product-types">
                    <div class="product-type">Product Test 1</div>
                    <div class="product-type">Product Test 2</div>
                </div>
            </div>
            <div id="model-year-field">
                <label id="model-year-label">Model Year:</label>
                <input type="text" class="model-year-input" id="model-year-input-from" />
                <input type="text" class="model-year-input" id="model-year-input-to" />
            </div>
            <div id="tech-box">
                <label id="tech-specs-label">Technical Specifications</label>
                <div id="tech-specs-dropdown">
                    <div id="airflow-field">
                        <label id="airflow-field-label">Airflow(CFM)</label>
                        <input type="range" id="airflow-field-range" />
                    </div>
                    <div id="maxpower-field">
                        <label id="maxpower-field-label">Max Power (W)</label>
                        <input type="range" id="maxpower-field-range" />
                    </div>
                    <div id="sound-field">
                        <label id="sound-field-label">Sound at max speed (dBA)</label>
                        <input type="range" id="sound-field-range" />
                    </div>
                    <div id="fanspeed-field">
                        <label id="fanspeed-field-label">Fan sweep diameter(in)</label>
                        <input type="range" id="fanspeed-field-range" />
                    </div>
                </div>
            </div>
        </div>
        <div id="products-div">
            <label id="products-div-label">Mechanical > HVAC Fans</label>
            <div id="cards-div">
                @foreach (var item in array)
                {

                    <div class="product-summary-card" dataId="@item.ProductId">
                        <img class="product-summary-img" src="@item.Product_Image" />
                        <label class="product-summary-company">@item.Manufacturer</label>
                        <label class="product-summary-series">@item.Series</label>
                        <label class="product-summary-id">@item.Id</label>
                        <label class="product-summary-airflow">@item.AirFlow</label>
                        <label class="product-summary-maxspeed">@item.MaxSpeed</label>
                        <label class="product-summary-sound">@item.Sound</label>
                        <label class="product-summary-fanspeed">@item.Speed</label>
                        <div id="product-summary-options">
                            <input class="product-summary-card-compare" type="checkbox" /> <label class="product-summary-card-compare-label">Compare</label>
                            <button class="product-summary-card-add" type="submit">Add to</button>
                        </div>
                    </div>

                }
                <div class="product-summary-card">
                    <img class="product-summary-img" />
                    <label class="product-summary-company">Big Ass</label>
                    <label class="product-summary-series">Haiku H Series</label>
                    <label class="product-summary-id">S3150</label>
                    <label class="product-summary-airflow">5.467 CFM</label>
                    <label class="product-summary-maxspeed">21.14 W at max speed</label>
                    <label class="product-summary-sound">35 dBa at max speed</label>
                    <label class="product-summary-fanspeed">60" fan sweep diameter</label>
                    <div id="product-summary-options">
                        <input class="product-summary-card-compare" type="checkbox" /> <label class="product-summary-card-compare-label">Compare</label>
                        <button class="product-summary-card-add" type="submit">Add to</button>
                    </div>
                </div>
                <div class="product-summary-card">
                    <img class="product-summary-img" />
                    <label class="product-summary-company">Big Ass</label>
                    <label class="product-summary-series">Haiku H Series</label>
                    <label class="product-summary-id">S3150</label>
                    <label class="product-summary-airflow">5.467 CFM</label>
                    <label class="product-summary-maxspeed">21.14 W at max speed</label>
                    <label class="product-summary-sound">35 dBa at max speed</label>
                    <label class="product-summary-fanspeed">60" fan sweep diameter</label>
                    <div id="product-summary-options">
                        <input class="product-summary-card-compare" type="checkbox" /> <label class="product-summary-card-compare-label">Compare</label>
                        <button class="product-summary-card-add" type="submit">Add to</button>
                    </div>
                </div>
                <div class="product-summary-card">
                    <img class="product-summary-img" src="https://mobileimages.lowes.com/productimages/7505a187-44c2-4c17-86b0-846ec7602a2d/09830240.jpg?size=pdhi" />
                    <label class="product-summary-company">Big Ass</label>
                    <label class="product-summary-series">Haiku H Series</label>
                    <label class="product-summary-id">S3150</label>
                    <label class="product-summary-airflow">5.467 CFM</label>
                    <label class="product-summary-maxspeed">21.14 W at max speed</label>
                    <label class="product-summary-sound">35 dBa at max speed</label>
                    <label class="product-summary-fanspeed">60" fan sweep diameter</label>
                    <div id="product-summary-options">
                        <input class="product-summary-card-compare" type="checkbox" /> <label class="product-summary-card-compare-label">Compare</label>
                        <button class="product-summary-card-add" type="submit">Add to</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</body>
</html>

<script>
    $(document).ready(function ()
    {

        // var subCategoryList = @Model.
        // var subCategory = $("a[data-selected='true']").next().attr("value");

        var disableAllSubCatOptions = function () {
            $("#subCategories").children("option").each(function () { $(this).prop("disabled", true) });

        }
        // disableAllSubCatOptions();

        $("#categoriesDropDown").on("click", "a", function (event) {
            disableAllSubCatOptions();
            // while($("#subCategories option"))
            let c = $(event.target).attr("value");
            $(`.${c}`).prop("disabled", false);
        });

        $("#search").submit(function (event) {
            console.log($("#searchInput").val());
            console.log($("#search").serializeArray());
            $(this).attr("method", "POST");
            $(this).attr("action", "https://" + window.location.host + "/Search/ProductSummary");
            console.log($(this).attr("action"));
            // event.preventDefault();
        });

        $(".dropBtn").click(function () {
            console.log("Drop button clicked");
            var parentClass = $(this).attr("data-class");
            console.log(parentClass);

            //console.log($(`.${parentClass} .drop`).attr("hidden"));
            console.log($(`.${parentClass} .drop`).is(":visible"));


            //if ($(`.${parentClass} .drop`).attr("hidden")) {
                if (!$(`.${parentClass} .drop`).is(":visible")) {
                //$(`.${parentClass} .drop`).attr("hidden", false);
                $(`.${parentClass} .drop`).show();
            } else {
                    //$(`.${parentClass} .drop`).attr("hidden", true);
                    $(`.${parentClass} .drop`).hide();
            }


        });

        var collectFilterInput = function () {
            console.log("In collectFilterInput");
            var minYear = $("#minModelYear").val();
            var maxYear = $("#maxModelYear").val();

            var filter = {
                minYear: minYear, maxYear: maxYear, prop: {}
            };
            console.log("minYear: " + minYear);
            console.log("maxYear: " + maxYear);
            var techSpecs = $("#tech-box #tech-specs-dropdown").children("div");
            for (var item of techSpecs) {

                var propId = $($(item).children("div")[0]).attr("dataId");
                //var val = $($(item).children("input")[0]).val();
                var val = $($($(item).children("div")[1]).children("input")[0]).val();
                filter.prop[ propId] =  val;
                console.log("propId: " + propId);
                console.log("val: " + val);
            }
            return filter;

        }
        collectFilterInput();
        var clearFilter = function () {
            $(".product-summary-card").each(function () {
                $(this).attr("hidden", false);
                //$(this).show();

            });
        }
        $("#searchButton").click(function () {
            console.log("searchButton clicked!");
            clearFilter();
            var filter = collectFilterInput();
            $(".Product").each(function () {
                console.log("data-modelyear"+$(this).attr("data-modelyear"));
                if (filter["minYear"] && filter["maxYear"]) {
                    if (!($(this).attr("data-modelyear") >= filter["minYear"] && $(this).attr("data-modelyear") <= filter["maxYear"])) {
                        $(this).attr("hidden", true);
                    }
                } else if (filter["minYear"]) {
                    if (!(this.attr["data-modelyear"] >= filter["minYear"])) {
                        $(this).attr("hidden", true);
                    }
                } else if (filter["maxYear"]) {
                    if (!(this.attr["data-modelyear"] <= filter["maxYear"])) {
                        $(this).attr("hidden", true);
                    }
                }
                var propElements = $(this).children(".propIDAndValue");
                for (var elem of propElements) {
                    if (filter.prop[$(elem).attr("data-propID")] < $(elem).attr("data-propertyValue")) {
                        $(this).attr("hidden", true);
                    }
                }

                //for (var item of filter.prop) {
                //    var propId = item["propId"];
                //    console.log("propId: " + propId);
                //    let e = $(".propIDAndValue")
                //    console.log($(e).attr("data-propertyVal") + "- propertyVal");
                //    console.log(e);
                //    if (item["val"] > $(e).attr("data-propertyVal")) {
                //        $(this).attr("hidden", true);
                //    }
                //}
            });
        });

        $("#clearButton").click(function () {
            clearFilter();

        });



        var disableAllSubCatOptions = function () {
            $("#subCategories").children("option").each(function () { $(this).prop("disabled", true) });

        }
        // disableAllSubCatOptions();

        $("#categoriesDropDown").on("click", "a", function (event) {
            disableAllSubCatOptions();
            // while($("#subCategories option"))
            let c = $(event.target).attr("value");
            $(`.${c}`).prop("disabled", false);
        });

        $("#searchInput").on('input', function () {
            var val = this.value;
            if ($('#subCategories option').filter(function () {
                return this.value.toUpperCase() === val.toUpperCase();
            }).length) {
                var id = $(`option[value='${val}']`).attr("data-id");
                $(this).attr("data-SubCategoryID", id);
            }
        });


        $("#search").submit(function (event) {
            console.log($("#searchInput").val());
            console.log($("#search").serializeArray());
            $(this).attr("method", "POST");
            $(this).attr("action", "https://" + window.location.host + "/Search/ProductSummary");
            var sid_val = $("#searchInput").attr("data-SubCategoryID");
            var sid = $(this).find("#SubCategoryID");

            if (sid.length != 0) {
                sid.remove();
            }
            $(this).append(`<input name='SubCategoryID' id='SubCategoryID' value='${sid_val}' hidden />`);
            console.log($(this).attr("action"));
            // event.preventDefault();
        });

        //click image
        $("div").on("click", ".prodImage", function () {
            console.log("clicked image!");
            var id = $(this).attr("dataId");

            window.location.href = `https://${window.location.host}/Products/ProductDetails/${id}`;

        })

         var compList = []

                // Handler for .ready() called.
                //clean the compare list
                compList = []
                //unchecked all checkbox
                $("input[type='checkbox']").prop('checked', false);
                $("input[type='checkbox']").change(addToCompare);
                $("#compare").click(MoveToCompare);


            function MoveToCompare() {
                console.log("click Compare");
                var n = compList.length;
                var params = `?id1=${n > 0 ? compList[0] : -1}&id2=${n > 1 ? compList[1] : -1}&id3=${n > 2 ? compList[2] : -1}`;
                console.log(params)
                window.location.href = '@Url.Action("ProductsCompare", "Products")' + params;

                //$.ajax({
                //    url: '',
                //    data: { ids: compList },
                //    success: function (data) {
                //        alert(data);

                //    }
                //});
            }
            function addToCompare() {
                if (this.checked) {
                    if (compList.length >= 3) {
                        var checkid = compList.shift()
                        $('#' + checkid).prop('checked', false)
                    }
                    compList.push($(this).prop('id'));
                }
                else {
                    var index = 0;
                    var checkid = $(this).prop('id');
                    for (let i = 0; i < compList.length; i++) {
                        if (compList[i] == checkid) {
                            index = i;
                        }
                    }
                    compList.splice(index, 1)
                }
                console.log(compList)
            };
    });
</script>